namespace dbgl
{
	template<typename T> Matrix3x3<T>::Matrix3x3()
	{
		_columns[0] = Vector3<T>(1,0,0);
		_columns[1] = Vector3<T>(0,1,0);
		_columns[1] = Vector3<T>(0,0,1);
	}
	
	template<typename T> Matrix3x3<T>::Matrix3x3(const Matrix3x3<T> &other)
	{
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
				_columns[x][y] = other[x][y];
	}

	template<typename T> Matrix3x3<T>::~Matrix3x3()
	{
	}
	
	template<typename T> int Matrix3x3<T>::getWidth() const
	{
		return 3;
	}
	
	template<typename T> int Matrix3x3<T>::getHeight() const
	{
		return 3;
	}
	
	template<typename T> void Matrix3x3<T>::transpose()
	{
		Matrix3x3<T> copy(*this); // Need old values
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
				(*this)[x][y] = copy[y][x];
	}
	
	template<typename T> Matrix3x3<T> Matrix3x3<T>::getTransposed() const
	{
		Matrix3x3<T> copy(*this);
		copy.transpose();
		return copy;
	}
	
	template<typename T> void Matrix3x3<T>::invert()
	{
		Matrix3x3<T> copy(*this);
		// a11a22a33+a21a32a13+a31a12a23-a11a32a23-a31a22a13-a21a12a33
		T determinant = copy[0][0] * copy[1][1] * copy[2][2] + copy[0][1] * copy[1][2] * copy[2][0] +
						copy[0][2] * copy[1][0] * copy[2][1] - copy[0][0] * copy[1][2] * copy[2][1] -
						copy[0][2] * copy[1][1] * copy[2][0] - copy[0][1] * copy[1][0] * copy[2][2];
		assert(determinant != 0);
		(*this)[0][0] = copy[1][1] * copy[2][2] - copy[2][1] * copy[1][2];
		(*this)[1][0] = copy[2][0] * copy[1][2] - copy[1][0] * copy[2][2];
		(*this)[2][0] = copy[1][0] * copy[2][1] - copy[2][0] * copy[1][1];
		(*this)[0][1] = copy[2][1] * copy[0][2] - copy[0][1] * copy[2][2];
		(*this)[1][1] = copy[0][0];
		(*this) *= 1 / determinant;
	}
	
	template<typename T> Matrix3x3<T> Matrix3x3<T>::getInverted() const
	{
		Matrix3x3<T> copy(*this);
		copy.invert();
		return copy;
	}
	
	template<typename T> bool Matrix3x3<T>::isZero()
	{
		for(int i = 0; i < getWidth(); i++)
			if(!(*this)[i].isZero())
				return false;
		return true;
	}
	
	template<typename T> bool Matrix3x3<T>::isIdentity()
	{
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
			{
				if(x == y && (*this)[x][y] != 1)
					return false;
				if(x != y && (*this)[x][y] != 0)
					return false;
			}
		return true;
	}
	
	template<typename T> Matrix3x3<T>& Matrix3x3<T>::operator=(Matrix3x3<T> const& rhs) 
	{ 
		if (*this != rhs)
		{ 
			for(int i = 0; i < getWidth(); i++)
				(*this)[i] = rhs[i];
		} 
		return *this;
	}
	
	template<typename T> const Matrix3x3<T> Matrix3x3<T>::operator+(Matrix3x3<T> const& rhs) 
	{ 
		Matrix3x3<T> tmp(*this);
		tmp += rhs;
		return tmp;
	}
	
	template<typename T> Matrix3x3<T>& Matrix3x3<T>::operator+=(Matrix3x3<T> const& rhs)
	{
		for(int i = 0; i < getWidth(); i++)
			(*this)[i] += rhs[i];
		return *this;
	}
	
	template<typename T> const Matrix3x3<T> Matrix3x3<T>::operator-(Matrix3x3<T> const& rhs) 
	{ 
		Matrix3x3<T> tmp(*this);
		tmp -= rhs;
		return tmp;
	}
		
	template<typename T> Matrix3x3<T>& Matrix3x3<T>::operator-=(Matrix3x3<T> const& rhs)
	{
		for(int i = 0; i < getWidth(); i++)
			(*this)[i] -= rhs[i];
		return *this;
	}
	
	template<typename T> const Matrix3x3<T> Matrix3x3<T>::operator*(Matrix3x3<T> const& rhs) 
	{
		Matrix3x3<T> copy(*this);
		copy *= rhs;
		return copy;
	}
	
	template<typename T> const Vector3<T> Matrix3x3<T>::operator*(Vector3<T> const& rhs)
	{
		Vector3<T> vec;
		for(int y = 0; y < getHeight(); y++)
			for(int x = 0; x < getWidth(); x++)
				vec[y] += (*this)[x][y] * rhs[x];
		return vec;
	}
	
	template<typename T> const Matrix3x3<T> Matrix3x3<T>::operator*(T const& rhs) 
	{ 
		Matrix3x3<T> tmp(*this);
		tmp *= rhs;
		return tmp;
	}
	
	template<typename T> Matrix3x3<T>& Matrix3x3<T>::operator*=(Matrix3x3<T> const& rhs) 
	{
		Matrix3x3<T> copy(*this);
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
			{
				(*this)[x][y] = 0;
				for(int i = 0; i < getHeight(); i++)
					(*this)[x][y] += copy[i][y] * rhs[x][i];
			}
		return *this;
	}
		
	template<typename T> Matrix3x3<T>& Matrix3x3<T>::operator*=(T const& rhs)
	{
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
				(*this)[x][y] *= rhs;
		return *this;
	}
	
	template<typename T> const Matrix3x3<T> Matrix3x3<T>::operator/(T const& rhs) 
	{ 
		Matrix3x3<T> tmp(*this);
		tmp /= rhs;
		return tmp;
	}
		
	template<typename T> Matrix3x3<T>& Matrix3x3<T>::operator/=(T const& rhs)
	{
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
				(*this)[x][y] /= rhs;
		return *this;
	}
	
	template<typename T> Matrix3x3<T> Matrix3x3<T>::operator-() const
	{
		Matrix3x3<T> tmp(*this);
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
				tmp[x][y] = -(*this)[x][y];
		return tmp;
	}
	
	template<typename T> bool Matrix3x3<T>::operator==(Matrix3x3<T> const& rhs)
	{
		for(int x = 0; x < getWidth(); x++)
			for(int y = 0; y < getHeight(); y++)
				if((*this)[x][y] != rhs[x][y])
					return false;
		return true;
	}
	
	template<typename T> bool Matrix3x3<T>::operator!=(Matrix3x3<T> const& rhs)
	{
		return !(*this == rhs);
	}

	template<typename T> Vector3<T>& Matrix3x3<T>::operator[](std::size_t const& index)
	{
		assert(index < getWidth());
		return _columns[index];
	}
	
	template<typename T> const Vector3<T>& Matrix3x3<T>::operator[](std::size_t const& index) const
	{
		assert(index < getWidth());
		return _columns[index];
	}
}
